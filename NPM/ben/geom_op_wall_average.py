import os
import sys
import builtins
import numpy as np
import ase, ase.build
from ase.visualize import view
from ase import Atoms
from ase.optimize import LBFGS
import quippy, quippy.descriptors
from quippy.potential import Potential

# SET UP UNIT CELL
a = 5.431
npm = Atoms(symbols=(['Si'] * 127),
                    cell=np.diag((4*a, a, 7*a)),
                    pbc=[1, 1, 1],
                    scaled_positions=[
                (0.000000009608344,    0.000000052806844,    0.142856867212050),
                (0.000000001422822,    0.500000021260612,    0.214285511007808),
                (0.062500005700050,    0.250000055988669,    0.178571188820291),
                (0.124999994447294,    0.000000021569761,    0.214285511169892),
                (0.062499995461045,    0.750000015973214,    0.249999833282440),
                (0.187499990331879,    0.250000021172770,    0.249999831697925),
                (0.187500004109919,    0.750000060362201,    0.178571191355111),
                (0.125000008248576,    0.500000065622232,    0.142856868962835),
                (0.250000008339455,    0.000000063717747,    0.142856871270773),
                (0.249999993314798,    0.500000021069331,    0.214285512073132),
                (0.312500004707617,    0.250000052736042,    0.178571194342780),
                (0.374999998951812,    0.000000015982394,    0.214285512125571),
                (0.312499992103689,    0.750000025020569,    0.249999831586059),
                (0.437499998148036,    0.250000026793602,    0.249999830285245),
                (0.437500006634636,    0.750000043489863,    0.178571194211946),
                (0.375000006902804,    0.500000053839925,    0.142856873337885),
                (0.500000008261989,    0.000000043350345,    0.142856872970126),
                (0.500000005643132,    0.500000020176038,    0.214285510556480),
                (0.562500009992399,    0.250000035702722,    0.178571192836450),
                (0.625000010028741,    0.000000025860670,    0.214285511041012),
                (0.562500007084492,    0.750000013312190,    0.249999829422418),
                (0.687500013946896,    0.250000011708892,    0.249999829997397),
                (0.687500011427911,    0.750000029423426,    0.178571191211147),
                (0.625000008478426,    0.500000040412194,    0.142856871613585),
                (0.750000009551832,    0.000000036895407,    0.142856869461573),
                (0.750000013708763,    0.500000026877069,    0.214285510393588),
                (0.812500012838375,    0.250000034230844,    0.178571187956042),
                (0.875000009739969,    0.000000025965952,    0.214285509438297),
                (0.812500014567266,    0.750000014802371,    0.249999831868898),
                (0.937500005203161,    0.250000013154473,    0.249999832909726),
                (0.937500010097887,    0.750000038716766,    0.178571187679111),
                (0.875000008921055,    0.500000053332732,    0.142856866452234),
                (0.999999997356179,    0.000000000715344,    0.285714156607421),
                (0.999999995323937,    0.499999977809503,    0.357142803099096),
                (0.062499992885245,    0.249999988954548,    0.321428479546259),
                (0.124999988022661,    0.999999965005980,    0.357142800024031),
                (0.062499995262847,    0.749999959827966,    0.392857124859018),
                (0.187499988247309,    0.249999970721797,    0.392857118643402),
                (0.187499984787765,    0.749999993861451,    0.321428474127799),
                (0.124999987988494,    0.499999991051019,    0.285714154572328),
                (0.249999983769658,    0.999999995632064,    0.285714152118700),
                (0.249999980972727,    0.499999970702935,    0.357142792344318),
                (0.312499985217491,    0.250000000562166,    0.321428470089455),
                (0.374999986233187,    0.999999977943688,    0.357142786009520),
                (0.312499984809850,    0.749999979739424,    0.392857107983357),
                (0.437499989197339,    0.249999992582032,    0.392857101455377),
                (0.437499992212768,    0.750000005931440,    0.321428466944603),
                (0.374999989947199,    0.499999999886804,    0.285714150174569),
                (0.499999999425017,    0.999999997924141,    0.285714148088626),
                (0.499999993771812,    0.499999982600340,    0.357142781947596),
                (0.562500001597720,    0.249999998917317,    0.321428465506434),
                (0.625000000425439,    0.999999982275466,    0.357142784106896),
                (0.562499993934005,    0.749999977995785,    0.392857100869049),
                (0.687499998580293,    0.249999960588697,    0.392857107186932),
                (0.687500009488954,    0.749999983947826,    0.321428469305458),
                (0.625000008163139,    0.500000002011850,    0.285714148587971),
                (0.750000010718399,    0.000000004777864,    0.285714151450215),
                (0.750000005014396,    0.499999981445747,    0.357142791874946),
                (0.812500010431977,    0.249999982382766,    0.321428474403014),
                (0.875000001642563,    0.999999983115201,    0.357142799934927),
                (0.812500002813824,    0.749999951016253,    0.392857117021492),
                (0.937499999888226,    0.249999952370806,    0.392857123766991),
                (0.937500001924093,    0.749999987431418,    0.321428478955138),
                (0.875000007163879,    0.500000003747391,    0.285714154876804),
                (0.999999992763554,    0.999999942259256,    0.428571446827252),
                (0.999999989991162,    0.499999922620932,    0.500000088687803),
                (0.062499995052700,    0.249999926998402,    0.464285769058727),
                (0.124999996320301,    0.999999919649927,    0.500000089207402),
                (0.062499995891730,    0.749999900072135,    0.535714410015174),
                (0.187500006762506,    0.249999930594788,    0.535714403156049),
                (0.187499994279655,    0.749999948308565,    0.464285762269094),
                (0.124999990363691,    0.499999940259400,    0.428571445401032),
                (0.249999987268071,    0.999999948094152,    0.428571435269745),
                (0.250000000563430,    0.499999935553172,    0.500000077567236),
                (0.312499993234083,    0.249999964407547,    0.464285748741028),
                (0.375000000021987,    0.999999974483220,    0.500000065575288),
                (0.312500007765268,    0.749999964983205,    0.535714390145006),
                (0.437500001075158,    0.249999983979450,    0.535714383108537),
                (0.437499988858975,    0.749999976776797,    0.464285739612536),
                (0.374999987069165,    0.499999966530843,    0.428571423943342),
                (0.499999989365984,    0.999999971748653,    0.428571418885176),
                (0.499999992185220,    0.499999992053829,    0.500000059037305),
                (0.562499985868283,    0.249999972821210,    0.464285739273990),
                (0.624999985238107,    0.999999979854447,    0.500000060617568),
                (0.562499987860840,    0.749999979231001,    0.535714381217301),
                (0.687499979268370,    0.249999952256900,    0.535714386383714),
                (0.687499986676537,    0.749999949635049,    0.464285746708933),
                (0.624999991869953,    0.499999967385110,    0.428571421622366),
                (0.749999994630788,    0.999999958624110,    0.428571430866906),
                (0.749999984145790,    0.499999963385268,    0.500000070882605),
                (0.812499990679161,    0.249999936178157,    0.464285758118175),
                (0.874999984448241,    0.999999933384910,    0.500000083159423),
                (0.812499969188428,    0.749999957515808,    0.535714400366628),
                (0.937499980133330,    0.249999929704304,    0.535714407132046),
                (0.937499992318986,    0.749999928108283,    0.464285767168151),
                (0.874999995897040,    0.499999949868387,    0.428571440984444),
                (0.250000018652000,    0.999999946285469,    0.571428719201042),
                (0.250000033378692,    0.499999991617872,    0.642857355776393),
                (0.312500022288798,    0.249999986693965,    0.607143031335319),
                (0.375000028331502,    0.000000023843922,    0.642857349931507),
                (0.312500029596988,    0.750000041490878,    0.678571668250510),
                (0.437500018401424,    0.250000023448374,    0.678571672024423),
                (0.437500011478476,    0.749999992704876,    0.607143027788556),
                (0.375000014727112,    0.499999987808310,    0.571428708260902),
                (0.500000000021234,    0.999999998299776,    0.571428704784305),
                (0.500000008530056,    0.500000012837643,    0.642857349457835),
                (0.562499994288228,    0.249999989417909,    0.607143027145698),
                (0.624999993858231,    0.999999996130490,    0.642857345255665),
                (0.562500000347034,    0.750000021850899,    0.678571669998150),
                (0.687499989948831,    0.250000019326844,    0.678571662337760),
                (0.687499985945980,    0.749999967601413,    0.607143025000707),
                (0.624999984952116,    0.499999985653820,    0.571428703664478),
                (0.250000028461702,    0.000000096237806,    0.714285977427528),
                (0.249999994037486,    0.500000160602901,    0.785714599706474),
                (0.312500016597173,    0.250000089405559,    0.750000302628666),
                (0.375000003402243,    0.000000094048392,    0.785714628954542),
                (0.312499964974028,    0.750000162895975,    0.821428937316112),
                (0.437499999944028,    0.250000056337274,    0.821428954860975),
                (0.437500012764604,    0.750000063110188,    0.750000317629670),
                (0.375000028749195,    0.500000066461304,    0.714285989611928),
                (0.500000012364561,    0.000000035298941,    0.714285994207203),
                (0.500000009323440,    0.500000036132185,    0.785714636131190),
                (0.562500006256576,    0.250000033794745,    0.750000315514565),
                (0.625000007465246,    0.000000014752593,    0.785714631973552),
                (0.562500019279763,    0.749999986381582,    0.821428955962309),
                (0.687499999847505,    0.750000050471528,    0.750000303164020),
                (0.624999999585782,    0.500000016924446,    0.714285988656463)])


# SET UP CALCULATOR
# Gaussian Approximation Potentials (GAP)
orig_dir = os.getcwd()
model_dir = os.path.dirname(sys.argv[0])
if model_dir != '':
    os.chdir(model_dir)

if os.path.exists('gp_iter6_sparse9k.xml.sparseX.GAP_2017_6_17_60_4_3_56_1651.bz2'):
    os.system('bunzip2 gp_iter6_sparse9k.xml.sparseX.GAP_2017_6_17_60_4_3_56_1651.bz2')

try:
    calc = Potential(init_args='Potential xml_label="GAP_2017_6_17_60_4_3_56_165"',
                                               param_filename='gp_iter6_sparse9k.xml')
    Potential.__str__ = lambda self: '<GAP Potential>'
finally:
    os.chdir(orig_dir)


no_checkpoint = True

npm.set_calculator(calc)

dyn = LBFGS(atoms=npm, trajectory='pillar.traj', restart='pillar.pckl')
dyn.run(fmax=0.05)
view(npm)

print(npm.get_scaled_positions())
