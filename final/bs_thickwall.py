import os
import sys
import builtins
import numpy as np
import ase, ase.build
from ase.visualize import view
from ase import Atoms
from phonopy import Phonopy
from phonopy.structure.atoms import PhonopyAtoms
from ase.optimize import LBFGS
import quippy, quippy.descriptors
from quippy.potential import Potential
from phonopy.phonon.band_structure import get_band_qpoints_and_path_connections

# SET UP UNIT CELL
a = 5.431
npm = Atoms(symbols=(['Si'] * 223),
                    cell=np.diag((4*a, a, 10*a)),
                    pbc=[1, 1, 0],
                    scaled_positions=[
                    (0.000000002092625,       0.000000010048723,       0.099999879461993),
                    (0.000000001403239,       0.500000010582845,       0.149999897592605),
                    (0.062500001482131,       0.250000008714608,       0.124999888145432),
                    (0.125000001403248,       0.000000010582883,       0.149999897592609),
                    (0.062500001346163,       0.750000006981727,       0.174999906126382),
                    (0.187500001346232,       0.250000006981453,       0.174999906126449),
                    (0.187500001482131,       0.750000008714606,       0.124999888145433),
                    (0.125000002092625,       0.500000010048723,       0.099999879461993),
                    (0.250000002092624,       0.000000010048724,       0.099999879461993),
                    (0.250000001403249,       0.500000010582890,       0.149999897592617),
                    (0.312500001482131,       0.250000008714607,       0.124999888145434),
                    (0.375000001403243,       0.000000010582866,       0.149999897592623),
                    (0.312500001346197,       0.750000006981592,       0.174999906126533),
                    (0.437500001346126,       0.250000006981871,       0.174999906126566),
                    (0.437500001482130,       0.750000008714610,       0.124999888145434),
                    (0.375000002092625,       0.500000010048723,       0.099999879461993),
                    (0.500000002092625,       0.000000010048724,       0.099999879461993),
                    (0.500000001403237,       0.500000010582840,       0.149999897592624),
                    (0.562500001482131,       0.250000008714611,       0.124999888145434),
                    (0.625000001403234,       0.000000010582826,       0.149999897592622),
                    (0.562500001346102,       0.750000006981964,       0.174999906126556),
                    (0.687500001346080,       0.250000006982058,       0.174999906126525),
                    (0.687500001482131,       0.750000008714612,       0.124999888145433),
                    (0.625000002092625,       0.500000010048725,       0.099999879461993),
                    (0.750000002092626,       0.000000010048722,       0.099999879461993),
                    (0.750000001403232,       0.500000010582815,       0.149999897592616),
                    (0.812500001482131,       0.250000008714614,       0.124999888145433),
                    (0.875000001403232,       0.000000010582814,       0.149999897592609),
                    (0.812500001346041,       0.750000006982213,       0.174999906126464),
                    (0.937500001346064,       0.250000006982120,       0.174999906126394),
                    (0.937500001482131,       0.750000008714611,       0.124999888145432),
                    (0.875000002092626,       0.500000010048719,       0.099999879461993),
                    (0.000000000674611,       0.000000006179449,       0.199999915610347),
                    (0.999999999928087,       0.500000004033503,       0.249999935593189),
                    (0.062500000415534,       0.250000003627608,       0.224999925586141),
                    (0.124999999909526,       0.000000003956526,       0.249999935556400),
                    (0.062499999727696,       0.750000001248108,       0.274999945505970),
                    (0.187499999778682,       0.250000001055642,       0.274999945369599),
                    (0.187500000417348,       0.750000003620585,       0.224999925583053),
                    (0.125000000675109,       0.500000006181414,       0.199999915610385),
                    (0.250000000674956,       0.000000006180795,       0.199999915610610),
                    (0.249999999938572,       0.500000004069962,       0.249999935524745),
                    (0.312500000404995,       0.250000003669983,       0.224999925573930),
                    (0.374999999986186,       0.000000004261236,       0.249999935476720),
                    (0.312499999948742,       0.750000000665559,       0.274999945276012),
                    (0.437499999946706,       0.250000000434967,       0.274999945294934),
                    (0.437500000413797,       0.750000003634576,       0.224999925562772),
                    (0.375000000674443,       0.500000006178761,       0.199999915610518),
                    (0.500000000674995,       0.000000006180996,       0.199999915610400),
                    (0.499999999939660,       0.500000004083419,       0.249999935466135),
                    (0.562500000433435,       0.250000003555819,       0.224999925568096),
                    (0.624999999932370,       0.000000004057740,       0.249999935509250),
                    (0.562499999900759,       0.750000000241279,       0.274999945299518),
                    (0.687499999833944,       0.250000000727822,       0.274999945327686),
                    (0.687500000426360,       0.750000003584011,       0.224999925580711),
                    (0.625000000675333,       0.500000006182362,       0.199999915610671),
                    (0.750000000674842,       0.000000006180409,       0.199999915610872),
                    (0.749999999986020,       0.500000004270370,       0.249999935542519),
                    (0.812500000422003,       0.250000003601407,       0.224999925586796),
                    (0.874999999989069,       0.000000004280745,       0.249999935584094),
                    (0.812499999857806,       0.750000000698429,       0.274999945450947),
                    (0.937499999643860,       0.250000001561004,       0.274999945568979),
                    (0.937500000418626,       0.750000003615005,       0.224999925588381),
                    (0.875000000674446,       0.500000006178818,       0.199999915610657),
                    (0.999999999872785,       0.000000004487920,       0.299999956065408),
                    (0.999999999657436,       0.500000002286299,       0.349999975896350),
                    (0.062500000017082,       0.250000001270359,       0.324999966513699),
                    (0.124999999951175,       0.000000003890634,       0.349999975987633),
                    (0.062500000454091,       0.749999997799586,       0.374999985313957),
                    (0.187500000044914,       0.249999999199709,       0.374999986098685),
                    (0.187499999904739,       0.750000001319148,       0.324999966307127),
                    (0.124999999980829,       0.500000003813816,       0.299999955926149),
                    (0.249999999866841,       0.000000002831636,       0.299999955716653),
                    (0.250000000062125,       0.500000003714521,       0.349999976209802),
                    (0.312499999733693,       0.249999999562025,       0.324999966176040),
                    (0.375000000130035,       0.000000003497503,       0.349999976265958),
                    (0.312499999943050,       0.749999999647479,       0.374999986731949),
                    (0.437500000316498,       0.249999999690829,       0.374999987001416),
                    (0.437499999812193,       0.749999998740913,       0.324999966189476),
                    (0.374999999731343,       0.500000002329687,       0.299999955593785),
                    (0.499999999862971,       0.000000002790283,       0.299999955581544),
                    (0.500000000420247,       0.500000003546273,       0.349999976305619),
                    (0.562499999826512,       0.249999998168122,       0.324999966260872),
                    (0.625000000582125,       0.000000003690216,       0.349999976324988),
                    (0.562500000734501,       0.749999999087654,       0.374999986822131),
                    (0.687500001109825,       0.249999999230524,       0.374999986140652),
                    (0.687499999758394,       0.749999998551529,       0.324999966285259),
                    (0.624999999792999,       0.500000003109868,       0.299999955693156),
                    (0.749999999659716,       0.000000003531710,       0.299999955754990),
                    (0.750000000413344,       0.500000002581276,       0.349999975891574),
                    (0.812500000036768,       0.249999997529797,       0.324999966391765),
                    (0.874999999876660,       0.000000002178360,       0.349999975797255),
                    (0.812500000935374,       0.749999996795141,       0.374999985425443),
                    (0.937500000621651,       0.249999996151450,       0.374999985109921),
                    (0.937500000135374,       0.750000000023219,       0.324999966625320),
                    (0.874999999902059,       0.500000005026003,       0.299999956040944),
                    (0.000000000482661,       0.000000003537551,       0.399999994344675),
                    (0.999999999709652,       0.500000002536501,       0.450000012811093),
                    (0.062500000208848,       0.249999997976865,       0.425000004028593),
                    (0.124999998377686,       0.000000003617896,       0.450000013891190),
                    (0.062499997266548,       0.749999999879337,       0.475000023376206),
                    (0.187499995255345,       0.250000000348303,       0.475000024602360),
                    (0.187499998935003,       0.749999995657817,       0.425000005516214),
                    (0.124999999777484,       0.500000005823993,       0.399999995117160),
                    (0.249999999316611,       0.000000003618915,       0.399999996485776),
                    (0.249999997216366,       0.500000002059000,       0.450000015675669),
                    (0.312499998598498,       0.249999996521696,       0.425000006978967),
                    (0.374999998061147,       0.999999996340463,       0.450000016562014),
                    (0.312499994056567,       0.750000005855433,       0.475000026208856),
                    (0.437499998716579,       0.249999998729880,       0.475000025786037),
                    (0.437499999742253,       0.749999997747796,       0.425000007287864),
                    (0.374999999622304,       0.500000001522096,       0.399999997366932),
                    (0.500000000608913,       0.000000001042125,       0.399999997415790),
                    (0.500000000958123,       0.500000000612034,       0.450000016401194),
                    (0.562500001199117,       0.249999998088668,       0.425000007109744),
                    (0.625000002913605,       0.999999998346594,       0.450000015767886),
                    (0.562500004588959,       0.749999987449635,       0.475000025915579),
                    (0.687500004779618,       0.249999991295118,       0.475000025315331),
                    (0.687500001974256,       0.749999999296467,       0.425000005935855),
                    (0.625000001228939,       0.499999998718887,       0.399999996720873),
                    (0.750000001174739,       0.999999996805849,       0.399999995362378),
                    (0.750000002166106,       0.499999993851863,       0.450000014275790),
                    (0.812500001482281,       0.249999998827169,       0.425000004313384),
                    (0.875000001393608,       0.999999996861636,       0.450000012903343),
                    (0.812500003112765,       0.749999991841506,       0.475000023406720),
                    (0.937500000337992,       0.249999997436573,       0.475000023152314),
                    (0.937500000933759,       0.749999997995563,       0.425000003271069),
                    (0.875000000489361,       0.499999997101849,       0.399999994361862),
                    (0.999999997340193,       0.999999994520564,       0.500000033850271),
                    (0.999999994447042,       0.499999983748315,       0.550000053395364),
                    (0.062499993266417,       0.249999996614624,       0.525000043366955),
                    (0.124999987881166,       0.999999982697167,       0.550000051567033),
                    (0.062499989298386,       0.749999994788348,       0.575000061782146),
                    (0.187499982949707,       0.249999997360794,       0.575000058213743),
                    (0.187499988079346,       0.750000000965488,       0.525000042197888),
                    (0.124999993143912,       0.499999992889157,       0.500000033757602),
                    (0.249999990585877,       0.999999998621962,       0.500000034902970),
                    (0.249999982156198,       0.499999980124639,       0.550000048733127),
                    (0.312499990352176,       0.250000000571412,       0.525000042097520),
                    (0.374999990028900,       0.999999974640520,       0.550000045726199),
                    (0.312499984520786,       0.749999990354966,       0.575000052434667),
                    (0.437499993624556,       0.249999981800844,       0.575000048574882),
                    (0.437499997107161,       0.749999987439618,       0.525000039802364),
                    (0.374999992800518,       0.499999988233275,       0.500000033679314),
                    (0.499999999586583,       0.999999988733977,       0.500000032761324),
                    (0.499999999887845,       0.499999976541684,       0.550000044238300),
                    (0.562500004241403,       0.249999972941919,       0.525000039672857),
                    (0.625000008068678,       0.999999986799137,       0.550000046448541),
                    (0.562500002871491,       0.749999970873718,       0.575000049382528),
                    (0.687500009903397,       0.249999961685320,       0.575000054621482),
                    (0.687500009740719,       0.749999975850962,       0.525000041555856),
                    (0.625000005981365,       0.499999994238930,       0.500000034508015),
                    (0.750000006241117,       0.999999990585548,       0.500000033515896),
                    (0.750000007731182,       0.499999983577575,       0.550000050141551),
                    (0.812500004439053,       0.249999980262348,       0.525000042650449),
                    (0.875000001332696,       0.999999988052723,       0.550000052582965),
                    (0.812500005587943,       0.749999964751307,       0.575000059850556),
                    (0.937499998036582,       0.249999975197620,       0.575000063128388),
                    (0.937499999102541,       0.749999987228082,       0.525000043686945),
                    (0.875000001539453,       0.499999992152089,       0.500000033613687),
                    (0.999999992028569,       0.999999974256282,       0.600000072873710),
                    (0.999999993629974,       0.499999975255486,       0.650000090439346),
                    (0.062499989389923,       0.249999990400463,       0.625000078846490),
                    (0.124999988649787,       0.999999974287280,       0.650000083487669),
                    (0.062499996765840,       0.749999987484211,       0.675000096304500),
                    (0.187499991563751,       0.249999999941611,       0.675000085192004),
                    (0.187499984147752,       0.749999992964207,       0.625000072002085),
                    (0.124999984435503,       0.499999978123921,       0.600000067917870),
                    (0.249999982067965,       0.999999969457367,       0.600000060962557),
                    (0.249999987522969,       0.499999968968196,       0.650000072414372),
                    (0.312499984909644,       0.249999994646575,       0.625000062006295),
                    (0.374999990503983,       0.999999981830127,       0.650000062446424),
                    (0.312499991894805,       0.750000001626896,       0.675000071093691),
                    (0.437499996407009,       0.249999991427976,       0.675000063696721),
                    (0.437499992813435,       0.749999983006389,       0.625000056521065),
                    (0.374999989487960,       0.499999971316907,       0.600000054179206),
                    (0.499999996970780,       0.999999979481415,       0.600000052241783),
                    (0.499999997821263,       0.499999985796863,       0.650000059430715),
                    (0.562500000608726,       0.249999967313918,       0.625000057775037),
                    (0.625000003778490,       0.999999984159545,       0.650000064440726),
                    (0.562500000117145,       0.749999971196109,       0.675000065017176),
                    (0.687500006139533,       0.249999905028412,       0.675000076676373),
                    (0.687500006873528,       0.749999946302187,       0.625000065946782),
                    (0.625000005662402,       0.499999983901764,       0.600000056339673),
                    (0.750000006416581,       0.999999978053032,       0.600000064309934),
                    (0.750000001290456,       0.499999963418055,       0.650000076830715),
                    (0.812500004023977,       0.249999947513620,       0.625000075045137),
                    (0.874999991449209,       0.999999956533592,       0.650000088772878),
                    (0.812499984037139,       0.749999941289192,       0.675000093003155),
                    (0.937499989805677,       0.249999961465103,       0.675000096318623),
                    (0.937499994524567,       0.749999965370323,       0.625000081264606),
                    (0.875000000901252,       0.499999979052572,       0.600000070529516),
                    (0.249999991738319,       0.999999940429362,       0.700000084185666),
                    (0.249999978748665,       0.500000032567833,       0.750000074896424),
                    (0.312499996673918,       0.250000022533280,       0.725000077193674),
                    (0.375000003324277,       0.000000028940147,       0.750000078319058),
                    (0.312499986399637,       0.750000035658632,       0.775000078199346),
                    (0.437500008250674,       0.250000032374567,       0.775000081976958),
                    (0.437500004552532,       0.750000024439491,       0.725000073472612),
                    (0.375000001887652,       0.500000003752533,       0.700000070719831),
                    (0.500000004789118,       0.000000017897763,       0.700000067728607),
                    (0.500000012707706,       0.500000037182149,       0.750000077601991),
                    (0.562500010130105,       0.250000003234219,       0.725000073949426),
                    (0.625000031209377,       0.000000019536732,       0.750000074175149),
                    (0.562500026375048,       0.750000020688322,       0.775000079970746),
                    (0.687500044754255,       0.250000034044321,       0.775000073705473),
                    (0.687500032070238,       0.750000010672597,       0.725000068715356),
                    (0.625000010751977,       0.500000011035080,       0.700000071248865),
                    (0.249999978522323,       0.000000072934882,       0.800000077448220),
                    (0.249999966437235,       0.500000091002969,       0.850000082684605),
                    (0.312499982425283,       0.250000066286422,       0.825000082895481),
                    (0.374999986639537,       0.000000059439605,       0.850000088714572),
                    (0.312499953680019,       0.750000131797256,       0.875000091864285),
                    (0.437499993539589,       0.250000034870430,       0.875000095633592),
                    (0.437500002597383,       0.750000037355799,       0.825000088007193),
                    (0.374999997479844,       0.500000059246122,       0.800000082015585),
                    (0.500000018060751,       0.000000018646543,       0.800000084633848),
                    (0.500000009333944,       0.500000016537285,       0.850000091879149),
                    (0.562500025514316,       0.250000024196466,       0.825000087549060),
                    (0.625000030407204,       0.999999990317806,       0.850000090545746),
                    (0.562500025517141,       0.749999981901480,       0.875000097552491),
                    (0.687500043942204,       0.750000046163122,       0.825000081373426),
                    (0.625000037601224,       0.500000006561244,       0.800000080787882)])


# SET UP CALCULATOR
# Gaussian Approximation Potentials (GAP)
orig_dir = os.getcwd()
model_dir = os.path.dirname(sys.argv[0])
if model_dir != '':
    os.chdir(model_dir)

if os.path.exists('gp_iter6_sparse9k.xml.sparseX.GAP_2017_6_17_60_4_3_56_1651.bz2'):
    os.system('bunzip2 gp_iter6_sparse9k.xml.sparseX.GAP_2017_6_17_60_4_3_56_1651.bz2')

try:
    calc = Potential(init_args='Potential xml_label="GAP_2017_6_17_60_4_3_56_165"',
                                               param_filename='gp_iter6_sparse9k.xml')
    Potential.__str__ = lambda self: '<GAP Potential>'
finally:
    os.chdir(orig_dir)


no_checkpoint = True

npm.set_calculator(calc)

dyn = LBFGS(atoms=npm, trajectory='thickwall.traj', restart='thickwall.pckl')
dyn.run(fmax=0.05)
view(npm)

print(npm.get_scaled_positions())

unitcell = PhonopyAtoms(['Si'] * 223,
                    cell=np.diag((4*a, a, 10*a)),
                    scaled_positions=npm.get_scaled_positions())


smat = [(2, 0, 0), (0, 2, 0), (0, 0, 1)]
phonon = Phonopy(unitcell, smat, primitive_matrix='auto')
phonon.generate_displacements(distance=0.03)
phonon.save(filename="phonopy_params_thickwall.yaml")
# CALCULATE DISPLACEMENTS
print("[Phonopy] Atomic displacements:")
disps = phonon.get_displacements()
for d in disps:
    print("[Phonopy] %d %s" % (d[0], d[1:]))

# CALCULATE FORCES
supercells = phonon.get_supercells_with_displacements()
set_of_forces = []
for scell in supercells:
    cell = Atoms(symbols=scell.get_chemical_symbols(),
                 scaled_positions=scell.get_scaled_positions(),
                 cell=scell.get_cell(),
                 pbc=True)
    cell.set_calculator(calc)
    forces = cell.get_forces()
    drift_force = forces.sum(axis=0)
    print(("[Phonopy] Drift force:" + "%11.5f" * 3) % tuple(drift_force))
    # Simple translational invariance
    for force in forces:
        force -= drift_force / forces.shape[0]
    set_of_forces.append(forces)

# PRODUCE FORCE CONSTANTS
phonon.produce_force_constants(forces=set_of_forces)
print('')
print("[Phonopy] Phonon frequencies at Gamma:")
for i, freq in enumerate(phonon.get_frequencies((0, 0, 0))):
    print("[Phonopy] %3d: %10.5f THz" %  (i + 1, freq)) # THz

print('')
print("[Phonopy] Phonon frequencies at U:")
for i, freq in enumerate(phonon.get_frequencies((0.5, 0.5, 0))):
    print("[Phonopy] %3d: %10.5f THz" %  (i + 1, freq)) # THz

# DOS
phonon.set_mesh([12, 12, 12])
phonon.set_total_DOS(tetrahedron_method=True)
print('')
print("[Phonopy] Phonon DOS:")
for omega, dos in np.array(phonon.get_total_DOS()).T:
    print("%15.7f%15.7f" % (omega, dos))

phonon.save(filename="phonopy_params_membrane.yaml",
settings={'force_constants': True, 'create_displacements': True})

# PLOT BAND STRUCTURE
path = [[[0, 0, 0], [0, 0.5, 0.5], [0.25, 0.75, 0.5], [0, 0, 0], [0.5, 0.5, 0.5]]]
labels = ["$\\Gamma$", "X", "K", "$\\Gamma$", "L"]

qpoints, connections = get_band_qpoints_and_path_connections(path, npoints=51)
phonon.run_band_structure(qpoints, path_connections=connections, labels=labels)
phonon.plot_band_structure_and_dos().show()

phonon.write_animation([8,8,8], anime_type='v_sim', filename='anime_thick.ascii')
